let products = {
  data: [
    {
      productName: "Pinball-kub",
      creator: "Thanut and Chanon",
      category: "Motion",
      price: "30",
      image: "../assets/images/products/motion/Pinball-Kub.png",
      link : "index.html",
      description: "An exciting interactive pinball game with stunning visual effects and smooth gameplay mechanics.",
      images: [
        "../assets/images/products/motion/Pinball-Kub.png"
      ],
      contactEmail: "contact@1103.com"
    },
    {
      productName: "Pinnball-MooDeng",
      creator: "Palise and Phurichaya",
      category: "Motion",
      price: "30",
      image: "../assets/images/products/motion/MooDeng.png",
      link : "haha.html",
      description: "A creative twist on classic pinball featuring unique character designs and engaging gameplay.",
      images: [
        "../assets/images/products/motion/MooDeng.png"
      ],
      contactEmail: "contact@1103.com"
    },
    {
      productName: "Pinball-SquidGame",
      creator: "Natapat and Phruek",
      category: "Motion",
      price: "99",
      image: "../assets/images/products/motion/Squid-Game.png",
      link : "index.html",
    },
    {
      productName: "Commercial-Zesto",
      creator: "Palise and Phurichaya",
      category: "Motion",
      price: "29",
      image: "../assets/images/products/motion/Zesto.png",
      link : "index.html",
    },
    {
      productName: "Commercial-TheBoys",
      creator: "Thanut Chanon Natapat and Phruek",
      category: "Motion",
      price: "129",
      image: "../assets/images/products/motion/The-Boys.png",
      link : "index.html",
    },
    {
      productName: "Lyrics-Blindinglights",
      creator: "Thanut Chanon Natapat and Phruek",
      category: "Motion",
      price: "89",
      image: "../assets/images/products/motion/Lyrics-Video.png",
      link : "index.html",
    },
    {
      productName: "Lyrics-Luther",
      creator: "Palise and Phurichaya",
      category: "Motion",
      price: "189",
      image: "../assets/images/products/motion/Love.png",
      link : "index.html",
    },
    {
      productName: "Factory-HarryPoter",
      creator: "Thanut Chanon Natapat and Phruek",
      category: "Motion",
      price: "49",
      image: "../assets/images/products/motion/Factory-Tour.png",
      link : "index.html",
    },
    {
      productName: "Factory-Teletubbies",
      creator: "Palise and Phurichaya",
      category: "Motion",
      price: "49",
      image: "../assets/images/products/motion/Teletubbies.png",
      link : "index.html",
    },
    {
      productName: "Museum",
      creator: "1103production",
      category: "Motion",
      price: "49",
      image: "../assets/images/products/motion/Museum.png",
      link : "index.html",
    },
     {
      productName: "Fossil",
      creator: "1103production",
      category: "Motion",
      price: "49",
      image: "../assets/images/products/motion/Fossil.png",
      link : "index.html",
    },
    {
      productName: "Loop",
      creator: "Natapat",
      category: "Motion",
      price: "49",
      image: "../assets/images/products/motion/Loop.png",
      link : "index.html",
    },
    {
      productName: "Lowlight",
      creator: "All",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Lowlight.jpg",
      link : "index.html",
    },
    {
      productName: "Street",
      creator: "Phruek",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Street_jump.jpg",
      link : "index.html",
    },
    {
      productName: "Food Dining",
      creator: "Palise Phurichaya Natapat and Thanut",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Food-Dining.jpg",
      link : "index.html",
    },
    {
      productName: "Different",
      creator: "Phruek and Chanon",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Different.jpg",
      link : "index.html",
    },
    {
      productName: "Stock photo",
      creator: "Phruek",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Stock_jump.HEIC",
      link : "index.html",
    },
    {
      productName: "City",
      creator: "Phurichaya",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/City.jpg",
      link : "index.html",
    },
    {
      productName: "Leaf",
      creator: "Phruek and Chanon",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Leaf_jumpchanon.jpg",
      link : "index.html",
    },
    {
      productName: "Goose",
      creator: "Phurichaya",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Duck_hut.HEIC",
      link : "index.html",
    },
    {
      productName: "BTS",
      creator: "Chanon",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/BTS_chanon.jpg",
      link : "index.html",
    },
    {
      productName: "Barn",
      creator: "Thanut",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Barn_TK.jpg",
      link : "index.html",
    },
    {
      productName: "Military",
      creator: "Phruek",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Military.jpg",
      link : "index.html",
    },
    {
      productName: "Building",
      creator: "Kadsan",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Building_Gram.Heic",
      link : "index.html",
    },
    {
      productName: "Cave",
      creator: "Phurichaya",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Cave_hut.jpg",
      link : "index.html",
    },
    {
      productName: "Hua-Lum-Phong",
      creator: "Kadsan",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/HuaLumPhong_Gram.Heic",
      link : "index.html",
    },
    {
      productName: "Meow",
      creator: "Phurichaya",
      category: "Production",
      price: "49",
      image: "../assets/images/products/production/Meow_hut.jpg",
      link : "index.html",
    },
    
    {
      productName: "",
      creator: "Natapat",
      category: "GraphicDesign",
      price: "49",
      image: "../assets/images/products/graphic/Photomanipulate_TK.png",
      link : "index.html",
    },
    {
      productName: "Fujii",
      creator: "Phruek",
      category: "GraphicDesign",
      price: "49",
      image: "../assets/images/products/graphic/Fujii_jump.png",
      link : "index.html",
    },
     {
      productName: "Wallpaper",
      creator: "Natapat",
      category: "GraphicDesign",
      price: "49",
      image: "../assets/images/products/graphic/Wallpaper_Nat2.png",
      link : "index.html",
    },
    {
      productName: "Poster-Korat",
      creator: "Phruek",
      category: "GraphicDesign",
      price: "49",
      image: "../assets/images/products/graphic/Korat4_jump.jpg",
      link : "index.html",
    },
    {
      productName: "Poster-Kanom",
      creator: "Natapat",
      category: "GraphicDesign",
      price: "49",
      image: "../assets/images/products/graphic/Commerc_Nat.png",
      link : "index.html",
    },
    {
      productName: "Shirt",
      creator: "Natapat",
      category: "GraphicDesign",
      price: "49",
      image: "../assets/images/products/graphic/Natshirt.png",
      link : "index.html",
    },
    {
      productName: "Poster-Eminem",
      creator: "Phruek",
      category: "GraphicDesign",
      price: "49",
      image: "../assets/images/products/graphic/Eminem_jump.png",
      link : "index.html",
    },
     {
      productName: "Mahito",
      creator: "Phreuk",
      category: "Artwork",
      price: "49",
      image: "../assets/images/products/artwork/Mahito_jump.png",
      link : "index.html",
    },
    {
      productName: "Pixel-Pigachu",
      creator: "Phruek",
      category: "Artwork",
      price: "49",
      image: "../assets/images/products/artwork/Pixel_jump.png",
      link : "index.html",
    },
    {
      productName: "Pixel-TK",
      creator: "Thanut",
      category: "Artwork",
      price: "49",
      image: "../assets/images/products/artwork/TK-Pixel.png",
      link : "index.html",
    },
    {
      productName: "Pixel-Shrek",
      creator: "Phurikchaya",
      category: "Artwork",
      price: "49",
      image: "../assets/images/products/artwork/sherkhut.png",
      link : "index.html",
    },
    
  ],
};

// Helper function to add default values for missing fields
function addDefaults(product) {
  return {
    ...product,
    description: product.description || `${product.productName} - A creative ${product.category} project by ${product.creator}.`,
    images: product.images || [product.image],
    contactEmail: product.contactEmail || "contact@1103.com"
  };
}

// Create modal HTML structure
function createModal() {
  const modal = document.createElement("div");
  modal.id = "product-modal";
  modal.classList.add("product-modal");
  modal.innerHTML = `
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <button class="modal-close" aria-label="Close modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      
      <div class="modal-content">
        <!-- Image Gallery Section -->
        <div class="modal-gallery">
          <div class="modal-main-image">
            <img id="modal-main-img" src="" alt="Product image">
          </div>
          <div class="modal-thumbnails" id="modal-thumbnails">
            <!-- Thumbnails will be added here -->
          </div>
        </div>
        
        <!-- Product Info Section -->
          <div class="modal-info">
          <button class="modal-category" id="modal-category" type="button"></button>
          <h1 class="modal-title" id="modal-title"></h1>
          <div class="modal-creator" id="modal-creator"></div>
          <div class="modal-price">
            <span class="modal-price-label">Price:</span>
            <span class="modal-price-value" id="modal-price-value">$0</span>
          </div>
          <p class="modal-description" id="modal-description"></p>
          
          <div class="modal-actions">
            <a href="#" class="modal-btn modal-btn-primary" id="modal-demo-btn" target="_blank">
              <span>Live Demo</span>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M3 13L13 3M13 3H5M13 3V11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </a>
            <a href="#" class="modal-btn modal-btn-secondary" id="modal-contact-btn">
              <span>Contact Author</span>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M2 4L8 8L14 4M2 4H14M2 4V12H14V4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  return modal;
}

// Initialize modal
let modal = null;
let currentProduct = null;

// Create cards - removed link wrapper, now uses click handler
for (let i of products.data) {
  // Add default values for missing fields
  const product = addDefaults(i);
  
  // Create Card (no link wrapper)
  let card = document.createElement("div");
  card.classList.add("card", product.category);
  card.dataset.productIndex = products.data.indexOf(i);
  // Store searchable metadata for later filtering (case-insensitive)
  card.dataset.productName = (product.productName || "").toUpperCase();
  card.dataset.creator = (product.creator || "Unknown Creator").toUpperCase();
  card.dataset.category = (product.category || "").toUpperCase();
  
  // Add click handler for modal
  card.addEventListener("click", () => openModal(product));
  
  //image div
  let imgContainer = document.createElement("div");
  imgContainer.classList.add("image-container");
  //img tag
  let image = document.createElement("img");
  image.setAttribute("src", product.image);
  image.setAttribute("alt", product.productName);
  imgContainer.appendChild(image);
  card.appendChild(imgContainer);
  
  //container
  let container = document.createElement("div");
  container.classList.add("container");
  //creator name
  let creator = document.createElement("p");
  creator.classList.add("creator-name");
  creator.innerText = product.creator || "Unknown Creator";
  container.appendChild(creator);
  //product name
  let name = document.createElement("h5");
  name.classList.add("product-name");
  name.innerText = product.productName.toUpperCase();
  container.appendChild(name);
  //price
  let price = document.createElement("h6");
  price.innerText = "$" + product.price;
  container.appendChild(price);

  card.appendChild(container);
  
 
  let cardWrapper = document.createElement("div");
  cardWrapper.classList.add("card-link");
  cardWrapper.appendChild(card);
  document.getElementById("products").appendChild(cardWrapper);
}

// Initialize GSAP ScrollTrigger 
function initCardAnimations(isFiltering = false) {
  gsap.registerPlugin(ScrollTrigger);
  
  
  ScrollTrigger.getAll().forEach(trigger => trigger.kill());
  
  const cardWrappers = document.querySelectorAll('.card-link:not(.hide)');
  
  cardWrappers.forEach((wrapper, index) => {
    
    gsap.set(wrapper, { opacity: 0, y: 50 });
    
  
    const rect = wrapper.getBoundingClientRect();
    const isInViewport = rect.top < window.innerHeight * 0.85;
    
    if (isFiltering && isInViewport) {
     
      gsap.to(wrapper, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        delay: index * 0.08,
        ease: "power2.out"
      });
    } else {
      
      gsap.to(wrapper, {
        opacity: 1,
        y: 0,
        duration: 0.6,
        delay: index * 0.1,
        ease: "power2.out",
        scrollTrigger: {
          trigger: wrapper,
          start: "top 85%",
          toggleActions: "play none none none"
        }
      });
    }
  });
}

//parameter passed from button (Parameter same as category)
function filterProduct(value) {
  // Clear search input when a category is clicked
  document.getElementById("search-input").value = "";

  //Button class code
  let buttons = document.querySelectorAll(".button-value");
  buttons.forEach((button) => {
    //check if value equals innerText
    if (value.toUpperCase() == button.innerText.toUpperCase()) {
      button.classList.add("active");
      // Update dropdown text
      updateCurrentFilter(button.innerText);
    } else {
      button.classList.remove("active");
    }
  });

  //select all cards and their parent wrappers
  let elements = document.querySelectorAll(".card");
  let wrappers = document.querySelectorAll(".card-link");
  //loop through all cards
  elements.forEach((element, index) => {
    const wrapper = wrappers[index];
    //display all cards on 'all' button click
    if (value == "all") {
      wrapper.classList.remove("hide");
    } else {
      //Check if element contains category class
      if (element.classList.contains(value)) {
        //display element based on category
        wrapper.classList.remove("hide");
      } else {
        //hide other elements
        wrapper.classList.add("hide");
      }
    }
  });
  
  // Close dropdown on mobile after selection
  if (window.innerWidth <= 944 && isDropdownOpen) {
    closeDropdown();
  }
  
  // Re-initialize animations for filtered cards
  setTimeout(() => {
    initCardAnimations(true);
  }, 50);
}

//Search function
function searchProducts() {
  //initializations
  let searchInput = document.getElementById("search-input").value.trim().toUpperCase();
  let cards = document.querySelectorAll(".card");
  let links = document.querySelectorAll(".card-link");

  // If search input is empty, show all cards (same as "all" filter)
  if (searchInput === "") {
    links.forEach((wrapper) => wrapper.classList.remove("hide"));
  } else {
    //loop through all cards
    cards.forEach((card, index) => {
      const wrapper = links[index];
      const productMatch = (card.dataset.productName || "").includes(searchInput);
      const creatorMatch = (card.dataset.creator || "").includes(searchInput);
      const categoryMatch = (card.dataset.category || "").includes(searchInput);
      const isSearchMatch = productMatch || creatorMatch || categoryMatch;

      if (isSearchMatch) {
        //display matching card
        wrapper.classList.remove("hide");
      } else {
        //hide others
        wrapper.classList.add("hide");
      }
    });
  }
  
  // Re-initialize animations for search results
  setTimeout(() => {
    initCardAnimations(true);
  }, 50);
}

// Reset category to "All" when user starts searching
document.getElementById("search-input").addEventListener("input", () => {
  // When user types in search, deactivate category buttons
  let buttons = document.querySelectorAll(".button-value");
  buttons.forEach((button) => {
    if (!button.innerText.includes("All")) {
      button.classList.remove("active");
    } else {
      button.classList.add("active");
    }
  });
  searchProducts();
});


//Search button click
document.querySelector("button#search").addEventListener("click", searchProducts);

// Dropdown Filter Animation (Awwwards Style)
let isDropdownOpen = false;
const filterToggle = document.getElementById('filterToggle');
const filterButtons = document.getElementById('buttons');
const currentFilterText = document.querySelector('.current-filter');

function initDropdownAnimation() {
  if (!filterToggle) return;

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.filter-wrapper') && isDropdownOpen) {
      closeDropdown();
    }
  });

  filterToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    if (isDropdownOpen) {
      closeDropdown();
    } else {
      openDropdown();
    }
  });

  // Handle window resize to fix visibility bug
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      handleResize();
    }, 150);
  });
}

function handleResize() {
  const isMobile = window.innerWidth <= 944;
  
  if (!isMobile) {
    // Desktop view - ensure filters are visible and reset dropdown state
    if (isDropdownOpen) {
      isDropdownOpen = false;
      filterToggle.classList.remove('active');
    }
    filterButtons.classList.remove('dropdown-open');
    // Reset GSAP properties for desktop
    gsap.set(filterButtons, { clearProps: "all" });
    const buttons = filterButtons.querySelectorAll('.button-value');
    gsap.set(buttons, { clearProps: "all" });
  } else {
    // Mobile view - ensure dropdown is properly closed
    if (isDropdownOpen) {
      closeDropdown();
    }
  }
}

function openDropdown() {
  isDropdownOpen = true;
  filterToggle.classList.add('active');
  filterButtons.classList.add('dropdown-open');

  // GSAP Animation - Awwwards style
  gsap.fromTo(filterButtons,
    {
      opacity: 0,
      scaleY: 0.8,
      y: -20
    },
    {
      opacity: 1,
      scaleY: 1,
      y: 0,
      duration: 0.4,
      ease: "power3.out"
    }
  );

  // Stagger animation for each button
  const buttons = filterButtons.querySelectorAll('.button-value');
  gsap.fromTo(buttons,
    {
      opacity: 0,
      x: -20
    },
    {
      opacity: 1,
      x: 0,
      duration: 0.3,
      stagger: 0.05,
      ease: "power2.out",
      delay: 0.1
    }
  );
}

function closeDropdown() {
  isDropdownOpen = false;
  filterToggle.classList.remove('active');

  // GSAP Animation - Smooth close
  gsap.to(filterButtons, {
    opacity: 0,
    scaleY: 0.9,
    y: -10,
    duration: 0.25,
    ease: "power2.in",
    onComplete: () => {
      filterButtons.classList.remove('dropdown-open');
    }
  });
}

// Update the current filter text in dropdown toggle
function updateCurrentFilter(filterName) {
  if (currentFilterText) {
    currentFilterText.textContent = filterName;
  }
}

// ==================== MODAL FUNCTIONS ====================
// 
// HOW TO USE:
// 1. Products automatically open modal when clicked
// 2. To add multiple images to a product, add an "images" array:
//    images: [
//      "../assets/images/products/motion/image1.png",
//      "../assets/images/products/motion/image2.png",
//      "../assets/images/products/motion/image3.png"
//    ]
// 3. To add a custom description, add a "description" field
// 4. To set a contact email, add a "contactEmail" field
// 5. If fields are missing, default values will be used automatically

// Open modal with product data
function openModal(product) {
  // Create modal if it doesn't exist
  if (!modal) {
    modal = createModal();
  }
  
  // Store current product
  currentProduct = product;
  
  // Populate modal with product data
  document.getElementById("modal-title").textContent = product.productName || "Untitled";
  
  // Set category button with click handler
  const categoryBtn = document.getElementById("modal-category");
  const category = product.category || "Project";
  categoryBtn.textContent = category;
  categoryBtn.dataset.category = category; // Store category for click handler
  
  // Add click handler to filter by category
  categoryBtn.onclick = (e) => {
    e.stopPropagation(); // Prevent modal close
    
    // Add smooth scale animation on click
    gsap.to(categoryBtn, {
      scale: 0.95,
      duration: 0.1,
      yoyo: true,
      repeat: 1,
      ease: "power2.inOut"
    });
    
    closeModal(); // Close modal first
    // Scroll to products section and filter after a short delay
    setTimeout(() => {
      const productsSection = document.getElementById("products");
      if (productsSection) {
        productsSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }
      // Filter products by category
      filterProduct(category);
    }, 300);
  };
  
  document.getElementById("modal-creator").innerHTML = `<span>By:</span> ${product.creator || "Unknown Creator"}`;
  document.getElementById("modal-description").textContent = product.description || "No description available.";
  
  // Animate price counting
  const priceElement = document.getElementById("modal-price-value");
  const price = parseFloat(product.price) || 0;
  
  // Reset to 0 first
  priceElement.textContent = "$0";
  
  // Animate counting up to the price
  gsap.to({ value: 0 }, {
    value: price,
    duration: 1.5,
    ease: "power2.out",
    onUpdate: function() {
      priceElement.textContent = "$" + Math.round(this.targets()[0].value);
    },
    delay: 0.5 // Delay to let other animations start first
  });
  
  // Set main image
  const mainImg = document.getElementById("modal-main-img");
  gsap.set(mainImg, { opacity: 1 }); // Ensure image is visible
  mainImg.src = product.images[0] || product.image;
  mainImg.alt = product.productName;
  
  // Create thumbnails
  const thumbnailsContainer = document.getElementById("modal-thumbnails");
  thumbnailsContainer.innerHTML = "";
  
  if (product.images && product.images.length > 1) {
    product.images.forEach((imgSrc, index) => {
      const thumbnail = document.createElement("div");
      thumbnail.classList.add("modal-thumbnail");
      if (index === 0) thumbnail.classList.add("active");
      
      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = `${product.productName} - Image ${index + 1}`;
      
      thumbnail.appendChild(img);
      thumbnail.addEventListener("click", () => {
        // Remove active class from all thumbnails
        thumbnailsContainer.querySelectorAll(".modal-thumbnail").forEach(t => t.classList.remove("active"));
        // Add active class to clicked thumbnail
        thumbnail.classList.add("active");
        
        // Smooth fade transition for main image
        gsap.to(mainImg, {
          opacity: 0,
          duration: 0.2,
          onComplete: () => {
            mainImg.src = imgSrc;
            gsap.to(mainImg, {
              opacity: 1,
              duration: 0.3,
              ease: "power2.out"
            });
          }
        });
      });
      
      thumbnailsContainer.appendChild(thumbnail);
    });
  }
  
  // Set button links
  document.getElementById("modal-demo-btn").href = product.link || "#";
  document.getElementById("modal-contact-btn").href = `mailto:${product.contactEmail}?subject=Inquiry about ${product.productName}`;
  
  // Show modal with GSAP animation
  modal.style.display = "block";
  document.body.style.overflow = "hidden"; // Prevent background scrolling
  
  // GSAP Animation - Awwwards style opening
  const backdrop = modal.querySelector(".modal-backdrop");
  const container = modal.querySelector(".modal-container");
  const content = modal.querySelector(".modal-content");
  const gallery = modal.querySelector(".modal-gallery");
  const info = modal.querySelector(".modal-info");
  
  // Set initial states
  gsap.set(backdrop, { opacity: 0 });
  gsap.set(container, { scale: 0.8, opacity: 0, y: 50 });
  gsap.set(content, { opacity: 0 });
  gsap.set(gallery, { x: -30, opacity: 0 });
  gsap.set(info, { x: 30, opacity: 0 });
  
  // Reset backdrop-filter blur to 0 initially
  backdrop.style.backdropFilter = "blur(0px)";
  backdrop.style.webkitBackdropFilter = "blur(0px)";
  
  // Create timeline for smooth sequential animation
  const tl = gsap.timeline();
  
  // Animate backdrop opacity
  tl.to(backdrop, {
    opacity: 1,
    duration: 0.4,
    ease: "power2.out"
  });
  
  // Animate container
  tl.to(container, {
    scale: 1,
    opacity: 1,
    y: 0,
    duration: 0.5,
    ease: "back.out(1.2)"
  }, "-=0.2");
  
  // Animate content
  tl.to(content, {
    opacity: 1,
    duration: 0.3
  }, "-=0.3");
  
  // Animate gallery and info side by side
  tl.to(gallery, {
    x: 0,
    opacity: 1,
    duration: 0.6,
    ease: "power3.out"
  }, "-=0.2");
  
  tl.to(info, {
    x: 0,
    opacity: 1,
    duration: 0.6,
    ease: "power3.out"
  }, "-=0.6");
  
  // Animate thumbnails with stagger
  const thumbnails = thumbnailsContainer.querySelectorAll(".modal-thumbnail");
  if (thumbnails.length > 0) {
    gsap.fromTo(thumbnails, 
      { scale: 0.8, opacity: 0 },
      {
        scale: 1,
        opacity: 1,
        duration: 0.4,
        stagger: 0.1,
        ease: "back.out(1.4)",
        delay: 0.8
      }
    );
  }
  
  // Add event listeners for closing (remove old ones first to avoid duplicates)
  const closeBtn = modal.querySelector(".modal-close");
  
  // Remove old listeners if they exist
  closeBtn.replaceWith(closeBtn.cloneNode(true));
  backdrop.replaceWith(backdrop.cloneNode(true));
  
  // Get fresh references after cloning
  const newCloseBtn = modal.querySelector(".modal-close");
  const newBackdrop = modal.querySelector(".modal-backdrop");
  
  // Reset backdrop blur to 0 after cloning
  newBackdrop.style.backdropFilter = "blur(0px)";
  newBackdrop.style.webkitBackdropFilter = "blur(0px)";
  
  // Add new listeners
  newCloseBtn.addEventListener("click", closeModal);
  newBackdrop.addEventListener("click", closeModal);
  
  // Remove old Escape listener if exists, then add new one
  document.removeEventListener("keydown", handleEscapeKey);
  document.addEventListener("keydown", handleEscapeKey);
  
  // Add active class to trigger blur transition with delay after listeners are set up
  setTimeout(() => {
    modal.classList.add("active");
  }, 200); // 200ms delay for blur transition
}

// Close modal function
function closeModal() {
  if (!modal) return;
  
  // Remove active class to trigger blur transition out
  modal.classList.remove("active");
  
  const backdrop = modal.querySelector(".modal-backdrop");
  const container = modal.querySelector(".modal-container");
  const gallery = modal.querySelector(".modal-gallery");
  const info = modal.querySelector(".modal-info");
  
  // Reset backdrop blur immediately for smooth transition
  if (backdrop) {
    backdrop.style.backdropFilter = "blur(0px)";
    backdrop.style.webkitBackdropFilter = "blur(0px)";
  }
  
  // Create closing timeline
  const tl = gsap.timeline({
    onComplete: () => {
      modal.style.display = "none";
      document.body.style.overflow = ""; // Restore scrolling
      currentProduct = null;
      // Reset backdrop blur state
      if (backdrop) {
        backdrop.style.backdropFilter = "";
        backdrop.style.webkitBackdropFilter = "";
      }
    }
  });
  
  // Animate out
  tl.to([gallery, info], {
    opacity: 0,
    x: (index) => index === 0 ? -30 : 30,
    duration: 0.3,
    ease: "power2.in"
  });
  
  tl.to(container, {
    scale: 0.9,
    opacity: 0,
    y: 20,
    duration: 0.4,
    ease: "power2.in"
  }, "-=0.2");
  
  tl.to(backdrop, {
    opacity: 0,
    duration: 0.3
  }, "-=0.2");
}

// Handle Escape key
function handleEscapeKey(e) {
  if (e.key === "Escape" && modal && modal.style.display === "block") {
    closeModal();
    document.removeEventListener("keydown", handleEscapeKey);
  }
}

//Initially display all products
window.onload = () => {
  filterProduct("all");
  // Initialize GSAP animations after products are loaded
  setTimeout(() => {
    initCardAnimations(false);
    initDropdownAnimation();
  }, 100);
};